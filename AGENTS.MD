# ü§ñ AGENTS.md - AI Coding Agent Guide

> **Purpose**: Quick reference for AI coding agents to understand this codebase.

---

## üìç Repository Overview

**What is this?** A Rust-based MCP (Model Context Protocol) client with:
- Full TUI interface (Ratatui)
- Multi-provider LLM support (Gemini, OpenAI, Ollama, Anthropic)
- Agent mode with tool calling
- REST API server

**Tech Stack**: Rust 1.75+, Tokio (async), Ratatui (TUI), Axum (HTTP), Serde (JSON)

---

## üóÇÔ∏è File Map

```
src/
‚îú‚îÄ‚îÄ bin/                    # Entry points
‚îÇ   ‚îú‚îÄ‚îÄ menu.rs            # Main TUI entry (cargo run)
‚îÇ   ‚îú‚îÄ‚îÄ rest.rs            # REST-only mode
‚îÇ   ‚îî‚îÄ‚îÄ stdio.rs           # STDIO-only mode
‚îÇ
‚îî‚îÄ‚îÄ lib/                    # Main library
    ‚îú‚îÄ‚îÄ mod.rs             # Top-level orchestration, run() function
    ‚îÇ
    ‚îú‚îÄ‚îÄ application/       # Business logic layer
    ‚îÇ   ‚îú‚îÄ‚îÄ agent/         # Agent with tool-calling loop
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ runner.rs  # Core ReAct loop (thought ‚Üí action ‚Üí observe)
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ parser.rs  # JSON response parsing
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ prompt.rs  # System prompt composition
    ‚îÇ   ‚îú‚îÄ‚îÄ client.rs      # McpClient - main client facade
    ‚îÇ   ‚îú‚îÄ‚îÄ stdio.rs       # Legacy text-based STDIO (deprecated)
    ‚îÇ   ‚îî‚îÄ‚îÄ tooling.rs     # Tool execution runtime
    ‚îÇ
    ‚îú‚îÄ‚îÄ cli/               # CLI argument parsing (clap)
    ‚îÇ
    ‚îú‚îÄ‚îÄ config/            # Configuration loading & wizard
    ‚îÇ   ‚îú‚îÄ‚îÄ loader.rs      # TOML config parsing
    ‚îÇ   ‚îú‚îÄ‚îÄ wizard/        # Interactive setup wizard
    ‚îÇ   ‚îî‚îÄ‚îÄ generator.rs   # Config file generation
    ‚îÇ
    ‚îú‚îÄ‚îÄ domain/            # Domain types (tool definitions, etc.)
    ‚îÇ
    ‚îú‚îÄ‚îÄ infrastructure/    # External integrations
    ‚îÇ   ‚îú‚îÄ‚îÄ model/         # LLM provider implementations
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ gemini.rs
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ openai.rs
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ollama.rs
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ anthropic.rs
    ‚îÇ   ‚îú‚îÄ‚îÄ server/        # REST API server (Axum)
    ‚îÇ   ‚îî‚îÄ‚îÄ rpc/           # JSON-RPC for MCP communication
    ‚îÇ
    ‚îî‚îÄ‚îÄ tui/               # TUI layer (Ratatui)  ‚≠ê NEW
        ‚îú‚îÄ‚îÄ terminal.rs    # Terminal init/restore, NavAction enum
        ‚îú‚îÄ‚îÄ widgets/       # Reusable widgets (Menu, TableMenu)
        ‚îî‚îÄ‚îÄ screens/       # Screen modules
            ‚îú‚îÄ‚îÄ mode_selector.rs   # Mode selection menu
            ‚îú‚îÄ‚îÄ setup_menu/        # Configuration management
            ‚îÇ   ‚îú‚îÄ‚îÄ mod.rs         # Main setup menu
            ‚îÇ   ‚îú‚îÄ‚îÄ providers.rs   # Manage LLM providers
            ‚îÇ   ‚îú‚îÄ‚îÄ models.rs      # Manage models
            ‚îÇ   ‚îú‚îÄ‚îÄ servers.rs     # Manage MCP servers
            ‚îÇ   ‚îú‚îÄ‚îÄ sync.rs        # Sync tools from servers
            ‚îÇ   ‚îî‚îÄ‚îÄ prompt.rs      # Edit prompt template
            ‚îî‚îÄ‚îÄ chat/              # Interactive chat ‚≠ê NEW (SOLID)
                ‚îú‚îÄ‚îÄ state.rs       # ChatState, ChatMessage
                ‚îú‚îÄ‚îÄ ui.rs          # Rendering (status, messages, input)
                ‚îú‚îÄ‚îÄ input.rs       # Keyboard handling
                ‚îî‚îÄ‚îÄ runner.rs      # Async event loop
```

---

## üîë Key Patterns

### 1. Terminal Reference Passing
TUI screens accept `&mut Tui` parameter to avoid reinitializing terminal:
```rust
pub fn run_manage_providers_with_terminal(terminal: &mut Tui) -> Result<()>
```

### 2. NavAction Enum
Single enum for all navigation actions in `tui/terminal.rs`:
```rust
pub enum NavAction {
    Up, Down, Select, Back, ForceQuit, None
}
```
- `q` key ‚Üí `ForceQuit` (exits entire app)
- `ESC` ‚Üí `Back` (go back one screen)

### 3. Async Channel Pattern (Chat)
Chat uses `mpsc::channel` for async LLM responses:
```rust
let (response_tx, mut response_rx) = mpsc::channel::<ResponseEvent>(10);
tokio::spawn(async move { send_message(..., tx).await; });
// In loop: response_rx.try_recv()
```

### 4. Configuration Loading
```rust
let config = AppConfig::load(Some(Path::new(CONFIG_PATH)))?;
```
Config at `config/client.toml`, API keys in `config/.env`.

### 5. Agent ReAct Loop
Agent expects JSON responses from LLM:
```json
{"action": "call_tool", "tool": "tool_name", "arguments": {...}}
{"action": "final", "response": "Final answer text"}
```

---

## üß≠ Common Tasks

### Add a new TUI screen
1. Create `src/lib/tui/screens/your_screen.rs`
2. Function signature: `pub fn run_your_screen(terminal: &mut Tui) -> Result<()>`
3. Export in `screens/mod.rs`

### Add a new LLM provider
1. Implement `ModelProvider` trait in `infrastructure/model/`
2. Add to `DynamicModelProvider::from_configs()`

### Add a new command in chat
1. Add variant to `CommandResult` in `chat/input.rs`
2. Add to `parse_command()` match
3. Handle in `handle_command()` in `chat/runner.rs`

### Modify config structure
1. Update structs in `config/loader.rs`
2. Update wizard in `config/wizard/`
3. Update `config.example/client.toml`

---

## ‚ö†Ô∏è Gotchas

1. **PowerShell exit codes**: `cargo build` may show exit code 1 due to PowerShell parsing, check for "Finished" text instead.

2. **Terminal state**: Always restore terminal on error paths to prevent broken terminal state.

3. **Unused code warnings**: Legacy functions may exist for backwards compatibility, check `#[allow(dead_code)]`.

4. **Async in TUI**: Use `tokio::task::block_in_place` or channels to bridge sync TUI with async operations.

5. **Windows line endings**: Files may have CRLF endings.

---

## üîß Quick Commands

```bash
cargo run                    # TUI mode selector
cargo run --bin stdio        # Direct STDIO mode
cargo run --bin rest         # Direct REST mode
cargo build                  # Build debug
cargo clippy                 # Lint
cargo fmt                    # Format
```

---

## üìä Agent Architecture

```mermaid
graph TD
    User([üë§ User]) <-->|Input/Output| TUI[üñ•Ô∏è TUI Chat]
    
    TUI --> Agent[ü§ñ Agent]
    
    subgraph "Agent Brain"
        Context[üìù Context & History]
        Planner[üß† Planner]
    end
    
    subgraph "Capabilities"
        LLM[‚òÅÔ∏è LLM Provider]
        Tools[üõ†Ô∏è MCP Tools]
    end
    
    Agent --> Context
    Agent --> Planner
    Planner <--> LLM
    Planner <-->|Call| Tools
    
    style TUI fill:#6c5ce7,stroke:#fff,color:#fff
    style Agent fill:#1a1a2e,stroke:#fff,color:#fff
    style LLM fill:#0f3460,stroke:#fff,color:#fff
    style Tools fill:#533483,stroke:#fff,color:#fff
```

---

## üìù Code Style

- **Error handling**: Use `Box<dyn Error>` for flexibility, `thiserror` for custom errors
- **Logging**: Use `tracing` crate (`info!`, `debug!`, `error!`)
- **Async**: Tokio runtime, avoid blocking in async contexts
- **TUI**: Ratatui with crossterm backend
- **Config**: TOML format with serde

---

## üîó Key Dependencies

| Crate | Purpose |
|:------|:--------|
| `ratatui` | TUI framework |
| `crossterm` | Terminal manipulation |
| `tokio` | Async runtime |
| `axum` | HTTP server |
| `serde` | Serialization |
| `clap` | CLI parsing |
| `tracing` | Logging |
